(function(){var Demo,Dot,Dots;new(Demo=function(){Demo.prototype.rootId="dots";Demo.prototype.webSocketUrl="wss://dotbot.herokuapp.com";Demo.prototype.webSocketProtocol="dotbot-stream";Demo.prototype.initialDelay=500;Demo.prototype.moveRequestInterval=500;Demo.prototype.reconnectDelay=5e3;Demo.prototype.targetQueueSize=20;Demo.prototype.pollingInterval=1e3;Demo.prototype.colors={R:"red",Y:"yellow",G:"green",B:"blue",V:"violet"};Demo.prototype.parseGrid=function(grid){var c,row,_i,_len,_results;_results=[];for(_i=0,_len=grid.length;_i<_len;_i++){row=grid[_i];_results.push(function(){var _j,_len1,_ref,_results1;_ref=row.split("");_results1=[];for(_j=0,_len1=_ref.length;_j<_len1;_j++){c=_ref[_j];_results1.push(this.colors[c])}return _results1}.call(this))}return _results};Demo.prototype.fmtGrid=function(grid){var c,row,_i,_len,_results;_results=[];for(_i=0,_len=grid.length;_i<_len;_i++){row=grid[_i];_results.push(function(){var _j,_len1,_results1;_results1=[];for(_j=0,_len1=row.length;_j<_len1;_j++){c=row[_j];_results1.push(c[0].toUpperCase())}return _results1}().join(""))}return _results};function Demo(){this.root=document.getElementById(this.rootId);this.queue=[];setTimeout(this.createWebSocket.bind(this),this.initialDelay)}Demo.prototype.createWebSocket=function(){this.ws=new WebSocket(this.webSocketUrl,this.webSocketProtocol);this.ws.onopen=this.onopen.bind(this);this.ws.onclose=this.onclose.bind(this);return this.ws.onmessage=this.onmessage.bind(this)};Demo.prototype.onopen=function(e){if(this.latestGrid!=null){e.target.send("setGrid:"+JSON.stringify(this.fmtGrid(this.latestGrid)))}return this.updateIntervalId=setInterval(function(_this){return function(){if(_this.queue.length<_this.targetQueueSize){return e.target.send("next")}}}(this),this.moveRequestInterval)};Demo.prototype.onclose=function(){console.log(new Date,"disconnected");clearInterval(this.updateIntervalId);return setTimeout(function(_this){return function(){console.log(new Date,"reconnecting...");return _this.createWebSocket()}}(this),this.reconnectDelay)};Demo.prototype.onmessage=function(msg){var data;data=JSON.parse(msg.data);data.grid=this.latestGrid=this.parseGrid(data.grid);if(data.path==null){return this.dots=new Dots(this.root,data.grid,this.update.bind(this))}else{return this.queue.push(data)}};Demo.prototype.update=function(){var data;if((data=this.queue.shift())!=null){return this.dots.drawPath(data.path,data.grid,this.update.bind(this))}else{return setTimeout(this.update.bind(this),this.pollingInterval)}};return Demo}());Dots=function(){Dots.prototype.fallingDotsDuration=250;Dots.prototype.drawPathDelay=100;Dots.prototype.clearPathDelay=500;Dots.prototype.dropDotsDelay=150;function Dots(root,grid,next){var r;this.root=root;this.grid=grid;this.dots=function(){var _i,_results;_results=[];for(r=_i=0;_i<=5;r=++_i){_results.push([])}return _results}();this.dropDots(this.grid,next)}Dots.prototype.getDot=function(r,c){return this.dots[r][c]};Dots.prototype.setDot=function(r,c,dot){return this.dots[r][c]=dot};Dots.prototype.delDot=function(r,c){return delete this.dots[r][c]};Dots.prototype.dropDots=function(grid,next){var c,dot,nextRowToFill,r,_i,_j,_k;this.grid=grid;for(c=_i=0;_i<=5;c=++_i){nextRowToFill=5;for(r=_j=5;_j>=0;r=--_j){if((dot=this.getDot(r,c))!=null){if(r!==nextRowToFill){dot.row(nextRowToFill);this.setDot(nextRowToFill,c,dot);this.delDot(r,c)}nextRowToFill-=1}}if(nextRowToFill>=0){for(r=_k=0;0<=nextRowToFill?_k<=nextRowToFill:_k>=nextRowToFill;r=0<=nextRowToFill?++_k:--_k){this.newDot(r,c)}}}return setTimeout(next,this.fallingDotsDuration+this.drawPathDelay)};Dots.prototype.newDot=function(r,c){var dot;dot=new Dot(r,c,this.grid[r][c]);dot.animateFall();this.setDot(r,c,dot);return this.root.appendChild(dot.element)};Dots.prototype.drawPath=function(path,newGrid,next){var drawNextSegment;return(drawNextSegment=function(_this){return function(path){var segment;_this.selectDot(_this.getDot.apply(_this,path[0]));if(path.length>1){segment=_this.newPathSegment(path[0],path[1]);return segment.addEventListener("animationend",function(){return drawNextSegment(path.slice(1))})}else if(path.length===1){return setTimeout(_this.clearPath.bind(_this,newGrid,next),_this.clearPathDelay)}}}(this))(path)};Dots.prototype.selectDot=function(dot,checkForCycle){if(checkForCycle==null){checkForCycle=true}if(checkForCycle&&dot.isMarkedForDeletion()){setTimeout(function(_this){return function(){var c,color,r,_i,_results;_this.root.dataset.color=color=dot.color();_results=[];for(r=_i=0;_i<=5;r=++_i){_results.push(function(){var _j,_results1;_results1=[];for(c=_j=0;_j<=5;c=++_j){if((dot=this.getDot(r,c)).color()===color){_results1.push(this.selectDot(dot,false))}else{_results1.push(void 0)}}return _results1}.call(_this))}return _results}}(this));return}if(!dot.isMarkedForDeletion()){dot.markForDeletion();if(this.toBeRemoved==null){this.toBeRemoved=[]}this.toBeRemoved.push(dot)}if(dot.selection!=null){dot.selection.element.remove()}dot.selection=new Dot(dot.row(),dot.col(),dot.color());dot.selection.animateSelection();return this.root.appendChild(dot.selection.element)};Dots.prototype.newPathSegment=function(_arg,_arg1){var c1,c2,r1,r2,segment;r1=_arg[0],c1=_arg[1];r2=_arg1[0],c2=_arg1[1];segment=document.createElement("div");segment.className="path-segment from-"+r1+"-"+c1+"-to-"+r2+"-"+c2;segment.dataset.color=this.grid[r1][c1];this.root.appendChild(segment);if(this.toBeRemoved==null){this.toBeRemoved=[]}this.toBeRemoved.push(segment);return segment};Dots.prototype.clearPath=function(newGrid,next){var x,_i,_len,_ref;if(this.root.dataset.color!=null){delete this.root.dataset.color}_ref=this.toBeRemoved;for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];if(x instanceof Dot){this.delDot(x.row(),x.col());x.animateShrinking()}else{x.remove()}}this.toBeRemoved=[];return setTimeout(this.dropDots.bind(this,newGrid,next),this.dropDotsDelay)};return Dots}();Dot=function(){function Dot(r,c,color){this.element=document.createElement("div");this.element.className="dot";this.row(r);this.col(c);this.color(color);this.element.dot=this}Dot.prototype.row=function(x){return this.element.dataset.row=x!=null?x:this.element.dataset.row};Dot.prototype.col=function(x){return this.element.dataset.col=x!=null?x:this.element.dataset.col};Dot.prototype.color=function(x){return this.element.dataset.color=x!=null?x:this.element.dataset.color};Dot.prototype.markForDeletion=function(){return this.element.classList.add("marked-for-deletion")};Dot.prototype.isMarkedForDeletion=function(){return this.element.classList.contains("marked-for-deletion")};Dot.prototype.animateFall=function(){this.element.classList.add("falling");return this.element.addEventListener("animationend",function(e){return e.target.classList.remove("falling")})};Dot.prototype.animateSelection=function(){return this.animateAndRemove("selecting")};Dot.prototype.animateShrinking=function(){return this.animateAndRemove("shrinking")};Dot.prototype.animateAndRemove=function(className){this.element.classList.add(className);return this.element.addEventListener("animationend",function(e){return e.target.remove()})};return Dot}()}).call(this);
//# sourceMappingURL=main.js.map