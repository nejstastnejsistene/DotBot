(function(){var Demo,Dots,colors,conf;conf={rootId:"dots",websocketUrl:"wss://dotbot.herokuapp.com",websocketProtocol:"dotbot-stream",initialDelay:500,moveRequestInterval:500,targetQueueSize:20,pollingInterval:50,drawPathDelay:100,fallingDotsDuration:250,segmentAnimationDuration:100,clearPathDelay:500};colors={R:"red",Y:"yellow",G:"green",B:"blue",V:"violet"};Demo=function(){function Demo(){this.root=document.getElementById(conf.rootId);this.ws=new WebSocket(conf.websocketUrl,conf.websocketProtocol);this.ws.onopen=this.onopen.bind(this);this.ws.onclose=this.onclose.bind(this);this.ws.onmessage=this.onmessage.bind(this);this.queue=[]}Demo.prototype.onopen=function(){this.running=true;this.ws.send("next");return this.intervalId=setInterval(function(_this){return function(){if(_this.running&&_this.queue.length<conf.targetQueueSize){return _this.ws.send("next")}}}(this),conf.moveRequestInterval)};Demo.prototype.onclose=function(){this.running=false;clearInterval(this.intervalId);return console.log("socket closed")};Demo.prototype.onmessage=function(msg){var c,data,row;data=JSON.parse(msg.data);data.grid=function(){var _i,_len,_ref,_results;_ref=data.grid;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){row=_ref[_i];_results.push(function(){var _j,_len1,_ref1,_results1;_ref1=row.split("");_results1=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){c=_ref1[_j];_results1.push(colors[c])}return _results1}())}return _results}();if(data.path==null){return this.dots=new Dots(this.root,data.grid,this.update.bind(this))}else{return this.queue.push(data)}};Demo.prototype.update=function(){var data;if((data=this.queue.shift())!=null){return setTimeout(function(_this){return function(){return _this.dots.drawPath(data.path,data.grid,_this.update.bind(_this))}}(this),conf.drawPathDelay)}else if(this.running){return setTimeout(this.update.bind(this),conf.pollingInterval)}};return Demo}();Dots=function(){function Dots(root,grid,next){this.root=root;this.grid=grid;this.dropDots(next)}Dots.prototype.dropDots=function(next){var c,dot,hiddenRow,nextRowToFill,r,_i,_j,_k;for(c=_i=0;_i<=5;c=++_i){nextRowToFill=5;for(r=_j=5;_j>=0;r=--_j){if((dot=this.getDot(r,c))!=null){this.moveDot(dot,"row"+r,"row"+nextRowToFill--)}}if(nextRowToFill>=0){for(r=_k=0;0<=nextRowToFill?_k<=nextRowToFill:_k>=nextRowToFill;r=0<=nextRowToFill?++_k:--_k){hiddenRow=5-nextRowToFill+r;this.newDot(hiddenRow,r,c)}}}return setTimeout(next,conf.fallingDotsDuration)};Dots.prototype.newDot=function(hr,r,c){var dot;dot=document.createElement("div");dot.className="dot hidden-row"+hr+" col"+c+" "+this.grid[r][c];this.root.appendChild(dot);return this.moveDot(dot,"hidden-row"+hr,"row"+r)};Dots.prototype.getDot=function(r,c){return this.root.getElementsByClassName("dot row"+r+" col"+c)[0]};Dots.prototype.moveDot=function(dot,oldRowClass,newRowClass){return setTimeout(function(){return dot.className=dot.className.replace(oldRowClass,newRowClass)})};Dots.prototype.drawPath=function(path,newGrid,next){var c,color,drawNextSegment,r,_i,_j,_k,_len,_ref,_ref1;if(path.length>1&&""+path[0]===""+path[path.length-1]){_ref=path[0],r=_ref[0],c=_ref[1];color=this.grid[r][c];for(r=_i=0;_i<=5;r=++_i){for(c=_j=0;_j<=5;c=++_j){if(this.grid[r][c]===color){this.getDot(r,c).className+=" marked"}}}}else{for(_k=0,_len=path.length;_k<_len;_k++){_ref1=path[_k],r=_ref1[0],c=_ref1[1];this.getDot(r,c).className+=" marked"}}return(drawNextSegment=function(_this){return function(path){if(path.length>1){_this.newPathSegment(path[0],path[1]);return setTimeout(function(){return drawNextSegment(path.slice(1))},conf.segmentAnimationDuration)}else if(path.length===1){return setTimeout(_this.clearPath.bind(_this,newGrid,next),conf.clearPathDelay)}}}(this))(path)};Dots.prototype.newPathSegment=function(_arg,_arg1){var c1,c2,r1,r2,segment;r1=_arg[0],c1=_arg[1];r2=_arg1[0],c2=_arg1[1];segment=document.createElement("div");segment.className="path-segment from-"+r1+"-"+c1+"-to-"+r2+"-"+c2+" "+this.grid[r1][c1];return this.root.appendChild(segment)};Dots.prototype.clearPath=function(grid,next){var elements;this.grid=grid;elements=this.root.getElementsByClassName("dot marked");while(elements[0]){elements[0].parentNode.removeChild(elements[0])}elements=this.root.getElementsByClassName("path-segment");while(elements[0]){elements[0].parentNode.removeChild(elements[0])}return this.dropDots(next)};return Dots}();setTimeout(function(){return new Demo},conf.initialDelay)}).call(this);
//# sourceMappingURL=main.js.map