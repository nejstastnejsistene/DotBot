(function(){var Demo,Dots;new(Demo=function(){Demo.prototype.rootId="dots";Demo.prototype.websocketUrl="wss://dotbot.herokuapp.com";Demo.prototype.websocketProtocol="dotbot-stream";Demo.prototype.initialDelay=500;Demo.prototype.moveRequestInterval=500;Demo.prototype.targetQueueSize=20;Demo.prototype.pollingInterval=50;Demo.prototype.colors={R:"red",Y:"yellow",G:"green",B:"blue",V:"violet"};function Demo(){this.root=document.getElementById(this.rootId);this.queue=[];setTimeout(function(_this){return function(){_this.ws=new WebSocket(_this.websocketUrl,_this.websocketProtocol);_this.ws.onopen=_this.onopen.bind(_this);_this.ws.onclose=_this.onclose.bind(_this);return _this.ws.onmessage=_this.onmessage.bind(_this)}}(this),this.initialDelay)}Demo.prototype.onopen=function(){this.running=true;return this.updateIntervalId=setInterval(function(_this){return function(){if(_this.running&&_this.queue.length<_this.targetQueueSize){return _this.ws.send("next")}}}(this),this.moveRequestInterval)};Demo.prototype.onclose=function(){this.running=false;clearInterval(this.updateIntervalId);return console.log("socket closed")};Demo.prototype.onmessage=function(msg){var c,data,row;data=JSON.parse(msg.data);data.grid=function(){var _i,_len,_ref,_results;_ref=data.grid;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){row=_ref[_i];_results.push(function(){var _j,_len1,_ref1,_results1;_ref1=row.split("");_results1=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){c=_ref1[_j];_results1.push(this.colors[c])}return _results1}.call(this))}return _results}.call(this);if(data.path==null){return this.dots=new Dots(this.root,data.grid,this.update.bind(this))}else{return this.queue.push(data)}};Demo.prototype.update=function(){var data;if((data=this.queue.shift())!=null){return this.dots.drawPath(data.path,data.grid,this.update.bind(this))}else if(this.running){return setTimeout(this.update.bind(this),this.pollingInterval)}};return Demo}());Dots=function(){Dots.prototype.drawPathDelay=100;Dots.prototype.clearPathDelay=500;function Dots(root,grid,next){this.root=root;this.grid=grid;this.dropDots(next)}Dots.prototype.dropDots=function(next){var c,dot,hiddenRow,nextRowToFill,r,_i,_j,_results;this.fallingDots=new(function(){function _Class(inProgress){this.inProgress=inProgress!=null?inProgress:0}_Class.prototype.add=function(dot){this.inProgress++;return dot.addEventListener("transitionend",function(_this){return function(){if(--_this.inProgress===0){return next()}}}(this))};return _Class}());_results=[];for(c=_i=0;_i<=5;c=++_i){nextRowToFill=5;for(r=_j=5;_j>=0;r=--_j){if((dot=this.getDot(r,c))!=null){if(r!==nextRowToFill){this.moveDot(dot,"row"+r,"row"+nextRowToFill)}nextRowToFill--}}if(nextRowToFill>=0){_results.push(function(){var _k,_results1;_results1=[];for(r=_k=0;0<=nextRowToFill?_k<=nextRowToFill:_k>=nextRowToFill;r=0<=nextRowToFill?++_k:--_k){hiddenRow=5-nextRowToFill+r;_results1.push(this.newDot(hiddenRow,r,c))}return _results1}.call(this))}else{_results.push(void 0)}}return _results};Dots.prototype.newDot=function(hr,r,c){var dot;dot=document.createElement("div");dot.className="dot hidden-row"+hr+" col"+c+" "+this.grid[r][c];this.root.appendChild(dot);return this.moveDot(dot,"hidden-row"+hr,"row"+r)};Dots.prototype.getDot=function(r,c){return this.root.getElementsByClassName("dot row"+r+" col"+c)[0]};Dots.prototype.moveDot=function(dot,oldRowClass,newRowClass){return setTimeout(function(_this){return function(){dot.className=dot.className.replace(oldRowClass,newRowClass);return _this.fallingDots.add(dot)}}(this))};Dots.prototype.drawPath=function(path,newGrid,next){var c,color,drawNextSegment,r,_i,_j,_k,_len,_ref,_ref1;if(path.length>1&&""+path[0]===""+path[path.length-1]){_ref=path[0],r=_ref[0],c=_ref[1];color=this.grid[r][c];for(r=_i=0;_i<=5;r=++_i){for(c=_j=0;_j<=5;c=++_j){if(this.grid[r][c]===color){this.getDot(r,c).className+=" marked"}}}}else{for(_k=0,_len=path.length;_k<_len;_k++){_ref1=path[_k],r=_ref1[0],c=_ref1[1];this.getDot(r,c).className+=" marked"}}return(drawNextSegment=function(_this){return function(path){var segment;if(path.length>1){segment=_this.newPathSegment(path[0],path[1]);return segment.addEventListener("animationend",function(){return drawNextSegment(path.slice(1))})}else if(path.length===1){return setTimeout(_this.clearPath.bind(_this,newGrid,next),_this.clearPathDelay)}}}(this))(path)};Dots.prototype.newPathSegment=function(_arg,_arg1){var c1,c2,r1,r2,segment;r1=_arg[0],c1=_arg[1];r2=_arg1[0],c2=_arg1[1];segment=document.createElement("div");segment.className="path-segment from-"+r1+"-"+c1+"-to-"+r2+"-"+c2+" "+this.grid[r1][c1];this.root.appendChild(segment);return segment};Dots.prototype.clearPath=function(grid,next){var elements;this.grid=grid;elements=this.root.getElementsByClassName("dot marked");while(elements[0]){elements[0].parentNode.removeChild(elements[0])}elements=this.root.getElementsByClassName("path-segment");while(elements[0]){elements[0].parentNode.removeChild(elements[0])}return this.dropDots(next)};return Dots}()}).call(this);
//# sourceMappingURL=main.js.map