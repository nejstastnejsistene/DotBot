(function(){var Demo,Dot,Dots,audio;new(Demo=function(){Demo.prototype.rootId="dots";Demo.prototype.webSocketUrl="wss://dotbot.herokuapp.com";Demo.prototype.webSocketProtocol="dotbot-stream";Demo.prototype.initialDelay=500;Demo.prototype.moveRequestInterval=500;Demo.prototype.reconnectDelay=5e3;Demo.prototype.targetQueueSize=20;Demo.prototype.pollingInterval=1e3;Demo.prototype.colors={R:"red",Y:"yellow",G:"green",B:"blue",V:"violet"};Demo.prototype.parseGrid=function(grid){var c,row,_i,_len,_results;_results=[];for(_i=0,_len=grid.length;_i<_len;_i++){row=grid[_i];_results.push(function(){var _j,_len1,_ref,_results1;_ref=row.split("");_results1=[];for(_j=0,_len1=_ref.length;_j<_len1;_j++){c=_ref[_j];_results1.push(this.colors[c])}return _results1}.call(this))}return _results};Demo.prototype.fmtGrid=function(grid){var c,row,_i,_len,_results;_results=[];for(_i=0,_len=grid.length;_i<_len;_i++){row=grid[_i];_results.push(function(){var _j,_len1,_results1;_results1=[];for(_j=0,_len1=row.length;_j<_len1;_j++){c=row[_j];_results1.push(c[0].toUpperCase())}return _results1}().join(""))}return _results};function Demo(){this.root=document.getElementById(this.rootId);this.queue=[];setTimeout(this.createWebSocket.bind(this),this.initialDelay)}Demo.prototype.createWebSocket=function(){this.ws=new WebSocket(this.webSocketUrl,this.webSocketProtocol);this.ws.onopen=this.onopen.bind(this);this.ws.onclose=this.onclose.bind(this);return this.ws.onmessage=this.onmessage.bind(this)};Demo.prototype.onopen=function(e){if(this.latestGrid!=null){e.target.send("setGrid:"+JSON.stringify(this.fmtGrid(this.latestGrid)))}return this.updateIntervalId=setInterval(function(_this){return function(){if(_this.queue.length<_this.targetQueueSize){return e.target.send("next")}}}(this),this.moveRequestInterval)};Demo.prototype.onclose=function(){console.log(new Date,"disconnected");clearInterval(this.updateIntervalId);return setTimeout(function(_this){return function(){console.log(new Date,"reconnecting...");return _this.createWebSocket()}}(this),this.reconnectDelay)};Demo.prototype.onmessage=function(msg){var data;data=JSON.parse(msg.data);data.grid=this.latestGrid=this.parseGrid(data.grid);if(data.path==null){return this.dots=new Dots(this.root,data.grid,this.update.bind(this))}else{return this.queue.push(data)}};Demo.prototype.update=function(){var data;if((data=this.queue.shift())!=null){return this.dots.drawPath(data.path,data.grid,this.update.bind(this))}else{return setTimeout(this.update.bind(this),this.pollingInterval)}};return Demo}());Dots=function(){Dots.prototype.fallingDotsDuration=250;Dots.prototype.drawPathDelay=100;Dots.prototype.clearPathDelay=500;Dots.prototype.dropDotsDelay=150;function Dots(root,grid,next){var r;this.root=root;this.grid=grid;this.dots=function(){var _i,_results;_results=[];for(r=_i=0;_i<=5;r=++_i){_results.push([])}return _results}();this.dropDots(this.grid,next)}Dots.prototype.getDot=function(r,c){return this.dots[r][c]};Dots.prototype.setDot=function(r,c,dot){return this.dots[r][c]=dot};Dots.prototype.delDot=function(r,c){return delete this.dots[r][c]};Dots.prototype.dropDots=function(grid,next){var c,dot,nextRowToFill,r,_i,_j,_k;this.grid=grid;for(c=_i=0;_i<=5;c=++_i){nextRowToFill=5;for(r=_j=5;_j>=0;r=--_j){if((dot=this.getDot(r,c))!=null){if(r!==nextRowToFill){dot.row(nextRowToFill);this.setDot(nextRowToFill,c,dot)}nextRowToFill-=1}}if(nextRowToFill>=0){for(r=_k=0;0<=nextRowToFill?_k<=nextRowToFill:_k>=nextRowToFill;r=0<=nextRowToFill?++_k:--_k){this.newDot(r,c)}}}return setTimeout(next,this.fallingDotsDuration+this.drawPathDelay)};Dots.prototype.newDot=function(r,c){var dot;dot=new Dot(r,c,this.grid[r][c]);dot.animateFall();this.setDot(r,c,dot);return this.root.appendChild(dot.element)};Dots.prototype.drawPath=function(path,newGrid,next){var drawNextSegment;this.path=path;drawNextSegment=function(_this){return function(remainingPath,n,cycleCompleted){var event,segment,_i,_len,_ref;if(cycleCompleted==null){cycleCompleted=false}if(_this.selectDot(_this.getDot.apply(_this,remainingPath[0]),!cycleCompleted)){cycleCompleted=true;audio.playSquare(n)}else if(path.length===1){audio.playShrinker()}else{audio.playDot(n)}if(remainingPath.length>1){segment=_this.newPathSegment(remainingPath[0],remainingPath[1]);_ref=["animationend","webkitAnimationEnd"];for(_i=0,_len=_ref.length;_i<_len;_i++){event=_ref[_i];segment.addEventListener(event,function(){return drawNextSegment(remainingPath.slice(1),n+1,cycleCompleted)})}return _this.root.appendChild(segment)}else if(remainingPath.length===1){return setTimeout(_this.clearPath.bind(_this,newGrid,next),_this.clearPathDelay)}}}(this);return drawNextSegment(path,1)};Dots.prototype.selectDot=function(dot,checkForCycle){if(checkForCycle==null){checkForCycle=true}if(checkForCycle&&dot.markedForDeletion){return this.completeSquare(dot.color())}if(!dot.markedForDeletion){dot.markedForDeletion=true;if(this.toBeRemoved==null){this.toBeRemoved=[]}this.toBeRemoved.push(dot)}if(dot.selection!=null){dot.selection.element.remove()}dot.selection=new Dot(dot.row(),dot.col(),dot.color());dot.selection.animateSelection();this.root.appendChild(dot.selection.element);return false};Dots.prototype.completeSquare=function(color){var c,dot,r,_i,_j,_k,_len,_ref,_results;this.root.dataset.color=color;for(r=_i=0;_i<=5;r=++_i){for(c=_j=0;_j<=5;c=++_j){if((dot=this.getDot(r,c)).color()===color){this.selectDot(dot,false)}}}_ref=this.getEncircledDots(this.path);_results=[];for(_k=0,_len=_ref.length;_k<_len;_k++){dot=_ref[_k];_results.push(this.selectDot(dot,false))}return _results};Dots.prototype.getEncircledDots=function(path){var c,encircled,r,visited,_i,_j,_k,_len,_ref;visited=function(){var _i,_results;_results=[];for(r=_i=0;_i<=5;r=++_i){_results.push([])}return _results}();for(_i=0,_len=path.length;_i<_len;_i++){_ref=path[_i],r=_ref[0],c=_ref[1];visited[r][c]=true}this.floodFill(visited);encircled=[];for(r=_j=0;_j<=5;r=++_j){for(c=_k=0;_k<=5;c=++_k){if(!visited[r][c]){encircled.push(this.getDot(r,c))}}}return encircled};Dots.prototype.floodFill=function(visited){var flood,i,_i;flood=function(r,c){var i,j,_i,_results;if(r<0||c<0||r>5||c>5||visited[r][c]){return}visited[r][c]=true;_results=[];for(i=_i=-1;_i<=1;i=++_i){_results.push(function(){var _j,_results1;_results1=[];for(j=_j=-1;_j<=1;j=++_j){if(i!==j){_results1.push(flood(r+i,c+j))}else{_results1.push(void 0)}}return _results1}())}return _results};for(i=_i=0;_i<=5;i=++_i){flood(i,0);flood(i,5);flood(0,i);flood(5,i)}return visited};Dots.prototype.newPathSegment=function(_arg,_arg1){var c1,c2,r1,r2,segment;r1=_arg[0],c1=_arg[1];r2=_arg1[0],c2=_arg1[1];segment=document.createElement("div");segment.className="path-segment from-"+r1+"-"+c1+"-to-"+r2+"-"+c2;segment.dataset.color=this.grid[r1][c1];if(this.toBeRemoved==null){this.toBeRemoved=[]}this.toBeRemoved.push(segment);return segment};Dots.prototype.clearPath=function(newGrid,next){var x,_i,_len,_ref;if(this.root.dataset.color!=null){delete this.root.dataset.color}_ref=this.toBeRemoved;for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];if(x instanceof Dot){this.delDot(x.row(),x.col());x.animateShrinking()}else{x.remove()}}this.toBeRemoved=[];return setTimeout(this.dropDots.bind(this,newGrid,next),this.dropDotsDelay)};return Dots}();Dot=function(){function Dot(r,c,color){this.element=document.createElement("div");this.element.className="dot";this.row(r);this.col(c);this.color(color)}Dot.prototype.row=function(x){return this.element.dataset.row=x!=null?x:this.element.dataset.row};Dot.prototype.col=function(x){return this.element.dataset.col=x!=null?x:this.element.dataset.col};Dot.prototype.color=function(x){return this.element.dataset.color=x!=null?x:this.element.dataset.color};Dot.prototype.animateFall=function(){this.element.classList.add("falling");return this.element.addEventListener("animationend",function(e){return e.target.classList.remove("falling")})};Dot.prototype.animateSelection=function(){return this.animateAndRemove("selecting")};Dot.prototype.animateShrinking=function(){return this.animateAndRemove("shrinking")};Dot.prototype.animateAndRemove=function(className){this.element.classList.add(className);return this.element.addEventListener("animationend",function(e){return e.target.remove()})};return Dot}();audio=new(function(){_Class.prototype.minDot=1;_Class.prototype.maxDot=13;_Class.prototype.minSquare=4;_Class.prototype.maxSquare=12;function _Class(){var i,_i,_j,_ref,_ref1,_ref2,_ref3;this.shrinker=new Audio("assets/crunch.aif");this.dots=[];for(i=_i=_ref=this.minDot,_ref1=this.maxDot;_ref<=_ref1?_i<=_ref1:_i>=_ref1;i=_ref<=_ref1?++_i:--_i){this.dots[i]=new Audio("assets/"+i+".aif")}this.squares=[];for(i=_j=_ref2=this.minSquare,_ref3=this.maxSquare;_ref2<=_ref3?_j<=_ref3:_j>=_ref3;i=_ref2<=_ref3?++_j:--_j){this.squares[i]=new Audio("assets/square_"+i+".aif")}}_Class.prototype.playShrinker=function(){return this.play(this.shrinker)};_Class.prototype.playDot=function(n){var i,numDots,seqIndex,seqLength;numDots=this.maxDot-this.minDot+1;seqLength=2*numDots-2;seqIndex=(n-1)%seqLength;i=seqIndex<numDots?seqIndex:seqLength-seqIndex;return this.play(this.dots[i+this.minDot])};_Class.prototype.playSquare=function(n){return this.play(this.squares[Math.max(this.minSquare,Math.min(this.maxSquare,n))])};_Class.prototype.play=function(audio){audio.currentTime=0;return audio.play()};return _Class}())}).call(this);
//# sourceMappingURL=main.js.map